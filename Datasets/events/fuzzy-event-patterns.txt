/**
 * @author Juan Boubeta-Puig <juan.boubeta@uca.es>, University of Cádiz, Spain
 * @date 10th February, 2017
 */

@Name('TimeDiffAvg')  
insert into TimeDiffAvg  
select current_timestamp() as timestamp, a1.stationId as stationId, 
  avg(Math.abs(a1.currentTs - a1.stationTs)) as timeDiff 
from pattern [every a1 = AirMeasurement].win:time_batch(3600 milliseconds) // 1-hour time_batch, please note that "(3600 milliseconds)" represents 3600000 ms
group by a1.stationId 
having avg(Math.abs(a1.currentTs - a1.stationTs)) is not null 

@Name('Malfunction') 
insert into Malfunction 
select current_timestamp() as timestamp, a1.stationId as stationId, 
  malfunctionFuzzy(a1.timeDiff) as delta 
from pattern [every a1 = TimeDiffAvg]

@Name('Failure') 
insert into Failure 
select current_timestamp() as timestamp, a1.stationId as stationId, 
  failureFuzzy(a1.timeDiff) as delta 
from pattern [every a1 = TimeDiffAvg]

@Name('MalfunctionTNorm') 
insert into MalfunctionTNorm 
select current_timestamp() as timestamp, stationId as stationId, 
  window(*).aggregate(1, (result, malfunction) => 
    (case when result = 0.0 and malfunction.delta = 0.0 then 0 
    else (result * malfunction.delta) / ((result + malfunction.delta) - 
    result * malfunction.delta) 
    end)) as t, 
  window(*).aggregate(0, (result, malfunction) => 
    (case when malfunction.delta = 0.0 then result + 1 else result 
    end)) as zeroDeltaNum 
from Malfunction.win:time_batch(86400 milliseconds) 
group by stationId

@Name('FailureTNorm') 
insert into FailureTNorm 
select current_timestamp() as timestamp, stationId as stationId, 
  window(*).aggregate(1, (result, failure) => 
    (case when result = 0.0 and failure.delta = 0.0 then 0 
    else (result * failure.delta) / ((result + failure.delta) - 
    result * failure.delta) 
    end)) as t, 
  window(*).aggregate(0, (result, failure) => 
    (case when failure.delta = 0.0 then result + 1 else result 
    end)) as zeroDeltaNum 
from Failure.win:time_batch(86400 milliseconds) 
group by stationId

@Name('MalfunctionReport')
insert into MalfunctionReport 
select a1.timestamp as timestamp, a1.stationId as stationId, 
  (case when a1.t >= 0.75 then 1 else -1 
  end) as status 
from MalfunctionTNorm a1

@Name('FailureReport') 
insert into FailureReport 
select a1.timestamp as timestamp, a1.stationId as stationId, 
  (case when a1.t >= 0.75 then 1 else -1 
  end) as status 
from FailureTNorm a1